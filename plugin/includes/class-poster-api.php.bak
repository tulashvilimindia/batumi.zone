<?php
/**
 * Poster API Endpoints
 *
 * Handles poster CRUD operations for service listings and media management
 *
 * @package Batumi_Zone_Core
 * @since 0.2.0
 * @updated 0.9.0-alpha - Added multilingual tag support
 */

if (!defined('ABSPATH')) {
    exit;
}

class Batumi_Poster_API {

    /**
     * API namespace
     */
    private $namespace = 'batumizone/v1';

    /**
     * Constructor
     */
    public function __construct() {
        add_action('rest_api_init', array($this, 'register_routes'));
    }

    /**
     * Register REST API routes
     */
    public function register_routes() {

        // GET /my/services
        register_rest_route($this->namespace, '/my/services', array(
            'methods'             => 'GET',
            'callback'            => array($this, 'get_my_services'),
            'permission_callback' => array($this, 'is_authenticated'),
            'args'                => array(
                'status' => array(
                    'sanitize_callback' => 'sanitize_text_field',
                ),
                'page' => array(
                    'default'           => 1,
                    'sanitize_callback' => 'absint',
                ),
                'per_page' => array(
                    'default'           => 20,
                    'sanitize_callback' => 'absint',
                ),
            ),
        ));

        // POST /my/services
        register_rest_route($this->namespace, '/my/services', array(
            'methods'             => 'POST',
            'callback'            => array($this, 'create_service'),
            'permission_callback' => array($this, 'is_authenticated'),
            'args'                => $this->get_service_args(),
        ));

        // GET /my/services/{id}
        register_rest_route($this->namespace, '/my/services/(?P<id>\d+)', array(
            'methods'             => 'GET',
            'callback'            => array($this, 'get_my_service'),
            'permission_callback' => array($this, 'is_authenticated'),
        ));

        // PUT /my/services/{id}
        register_rest_route($this->namespace, '/my/services/(?P<id>\d+)', array(
            'methods'             => 'PUT',
            'callback'            => array($this, 'update_service'),
            'permission_callback' => array($this, 'is_authenticated'),
            'args'                => $this->get_service_args(),
        ));

        // POST /my/services/{id}/publish
        register_rest_route($this->namespace, '/my/services/(?P<id>\d+)/publish', array(
            'methods'             => 'POST',
            'callback'            => array($this, 'publish_service'),
            'permission_callback' => array($this, 'is_authenticated'),
        ));

        // POST /my/services/{id}/pause
        register_rest_route($this->namespace, '/my/services/(?P<id>\d+)/pause', array(
            'methods'             => 'POST',
            'callback'            => array($this, 'pause_service'),
            'permission_callback' => array($this, 'is_authenticated'),
        ));

        // POST /my/services/{id}/activate
        register_rest_route($this->namespace, '/my/services/(?P<id>\d+)/activate', array(
            'methods'             => 'POST',
            'callback'            => array($this, 'activate_service'),
            'permission_callback' => array($this, 'is_authenticated'),
        ));

        // DELETE /my/services/{id}
        register_rest_route($this->namespace, '/my/services/(?P<id>\d+)', array(
            'methods'             => 'DELETE',
            'callback'            => array($this, 'delete_service'),
            'permission_callback' => array($this, 'is_authenticated'),
        ));

        // POST /my/services/{id}/media
        register_rest_route($this->namespace, '/my/services/(?P<id>\d+)/media', array(
            'methods'             => 'POST',
            'callback'            => array($this, 'upload_media'),
            'permission_callback' => array($this, 'is_authenticated'),
        ));

        // POST /my/services/{id}/media/reorder
        register_rest_route($this->namespace, '/my/services/(?P<id>\d+)/media/reorder', array(
            'methods'             => 'POST',
            'callback'            => array($this, 'reorder_media'),
            'permission_callback' => array($this, 'is_authenticated'),
            'args'                => array(
                'order' => array(
                    'required' => true,
                    'type'     => 'array',
                ),
            ),
        ));

        // DELETE /my/services/{id}/media/{media_id}
        register_rest_route($this->namespace, '/my/services/(?P<id>\d+)/media/(?P<media_id>\d+)', array(
            'methods'             => 'DELETE',
            'callback'            => array($this, 'delete_media'),
            'permission_callback' => array($this, 'is_authenticated'),
        ));
    }

    /**
     * Get user's own services
     */
    public function get_my_services($request) {
        $user_id = get_current_user_id();

        $args = array(
            'post_type'      => 'service_listing',
            'author'         => $user_id,
            'posts_per_page' => $request['per_page'],
            'paged'          => $request['page'],
            'orderby'        => 'date',
            'order'          => 'DESC',
        );

        // Filter by status if provided
        if (!empty($request['status'])) {
            $args['post_status'] = $request['status'];
        } else {
            $args['post_status'] = array('draft', 'publish', 'inactive', 'removed');
        }

        $query = new WP_Query($args);
        $services = array();

        foreach ($query->posts as $post) {
            $services[] = $this->format_my_service($post);
        }

        return new WP_REST_Response(array(
            'services' => $services,
            'total'    => $query->found_posts,
            'pages'    => $query->max_num_pages,
        ), 200);
    }

    /**
     * Get single service (must be owned by current user)
     */
    public function get_my_service($request) {
        $service_id = $request['id'];

        // Verify ownership
        if (!$this->verify_ownership($service_id)) {
            return new WP_Error(
                'forbidden',
                __('You do not have permission to access this service.', 'batumizone-core'),
                array('status' => 403)
            );
        }

        $post = get_post($service_id);

        return new WP_REST_Response($this->format_my_service($post), 200);
    }

    /**
     * Create new service listing
     */
    public function create_service($request) {
        $user_id = get_current_user_id();

        // Create post
        $post_id = wp_insert_post(array(
            'post_type'   => 'service_listing',
            'post_status' => 'draft',
            'post_author' => $user_id,
            'post_title'  => 'Service Listing ' . time(), // Temporary title
        ));

        if (is_wp_error($post_id)) {
            return new WP_Error(
                'creation_failed',
                $post_id->get_error_message(),
                array('status' => 500)
            );
        }

        // Update ACF fields
        $this->update_service_fields($post_id, $request);

        // Set taxonomies
        $this->update_service_taxonomies($post_id, $request);

        // Get validation status
        $validation_result = $this->get_validation_status($post_id);

        return new WP_REST_Response(array(
            'success'           => true,
            'id'                => $post_id,
            'status'            => 'draft',
            'can_publish'       => $validation_result['valid'],
            'validation_errors' => $validation_result['errors'],
        ), 201);
    }

    /**
     * Update existing service
     */
    public function update_service($request) {
        $service_id = $request['id'];

        // Verify ownership
        if (!$this->verify_ownership($service_id)) {
            return new WP_Error(
                'forbidden',
                __('You do not have permission to edit this service.', 'batumizone-core'),
                array('status' => 403)
            );
        }

        // Update ACF fields
        $this->update_service_fields($service_id, $request);

        // Update taxonomies
        $this->update_service_taxonomies($service_id, $request);

        // Get validation status
        $validation_result = $this->get_validation_status($service_id);

        return new WP_REST_Response(array(
            'success'           => true,
            'id'                => $service_id,
            'can_publish'       => $validation_result['valid'],
            'validation_errors' => $validation_result['errors'],
        ), 200);
    }

    /**
     * Publish service (runs validation)
     */
    public function publish_service($request) {
        $service_id = $request['id'];

        // Verify ownership
        if (!$this->verify_ownership($service_id)) {
            return new WP_Error(
                'forbidden',
                __('You do not have permission to publish this service.', 'batumizone-core'),
                array('status' => 403)
            );
        }

        // Run validation
        $validation_result = $this->get_validation_status($service_id);

        if (!$validation_result['valid']) {
            return new WP_REST_Response(array(
                'success'           => false,
                'status'            => 'draft',
                'message'           => __('Service cannot be published due to validation errors.', 'batumizone-core'),
                'validation_errors' => $validation_result['errors'],
            ), 400);
        }

        // Publish
        wp_update_post(array(
            'ID'          => $service_id,
            'post_status' => 'publish',
        ));

        return new WP_REST_Response(array(
            'success'           => true,
            'status'            => 'publish',
            'message'           => __('Service published successfully.', 'batumizone-core'),
            'validation_errors' => array(),
        ), 200);
    }

    /**
     * Pause service (change to inactive)
     */
    public function pause_service($request) {
        $service_id = $request['id'];

        // Verify ownership
        if (!$this->verify_ownership($service_id)) {
            return new WP_Error(
                'forbidden',
                __('You do not have permission to pause this service.', 'batumizone-core'),
                array('status' => 403)
            );
        }

        wp_update_post(array(
            'ID'          => $service_id,
            'post_status' => 'inactive',
        ));

        return new WP_REST_Response(array(
            'success' => true,
            'status'  => 'inactive',
            'message' => __('Service paused successfully.', 'batumizone-core'),
        ), 200);
    }

    /**
     * Activate service (change from inactive to publish)
     */
    public function activate_service($request) {
        $service_id = $request['id'];

        // Verify ownership
        if (!$this->verify_ownership($service_id)) {
            return new WP_Error(
                'forbidden',
                __('You do not have permission to activate this service.', 'batumizone-core'),
                array('status' => 403)
            );
        }

        // Run validation before activating
        $validation_result = $this->get_validation_status($service_id);

        if (!$validation_result['valid']) {
            return new WP_REST_Response(array(
                'success'           => false,
                'status'            => 'inactive',
                'message'           => __('Service cannot be activated due to validation errors.', 'batumizone-core'),
                'validation_errors' => $validation_result['errors'],
            ), 400);
        }

        wp_update_post(array(
            'ID'          => $service_id,
            'post_status' => 'publish',
        ));

        return new WP_REST_Response(array(
            'success'           => true,
            'status'            => 'publish',
            'message'           => __('Service activated successfully.', 'batumizone-core'),
            'validation_errors' => array(),
        ), 200);
    }

    /**
     * Delete service (soft delete - change to removed)
     */
    public function delete_service($request) {
        $service_id = $request['id'];

        // Verify ownership
        if (!$this->verify_ownership($service_id)) {
            return new WP_Error(
                'forbidden',
                __('You do not have permission to delete this service.', 'batumizone-core'),
                array('status' => 403)
            );
        }

        wp_update_post(array(
            'ID'          => $service_id,
            'post_status' => 'removed',
        ));

        return new WP_REST_Response(array(
            'success' => true,
            'status'  => 'removed',
            'message' => __('Service deleted successfully.', 'batumizone-core'),
        ), 200);
    }

    /**
     * Upload media to service
     */
    public function upload_media($request) {
        $service_id = $request['id'];

        // Verify ownership
        if (!$this->verify_ownership($service_id)) {
            return new WP_Error(
                'forbidden',
                __('You do not have permission to upload media to this service.', 'batumizone-core'),
                array('status' => 403)
            );
        }

        // Check max images limit
        $current_gallery = get_post_meta($service_id, '_gallery_image_ids', true);
        $current_ids = !empty($current_gallery) ? explode(',', $current_gallery) : array();

        if (count($current_ids) >= 5) {
            return new WP_Error(
                'max_images',
                __('Maximum 5 images allowed per listing.', 'batumizone-core'),
                array('status' => 400)
            );
        }

        // Handle file upload
        require_once ABSPATH . 'wp-admin/includes/file.php';
        require_once ABSPATH . 'wp-admin/includes/media.php';
        require_once ABSPATH . 'wp-admin/includes/image.php';

        // Get the uploaded file from $_FILES
        $files = $request->get_file_params();

        if (empty($files['file'])) {
            return new WP_Error(
                'no_file',
                __('No file provided.', 'batumizone-core'),
                array('status' => 400)
            );
        }

        // Upload the file
        $attachment_id = media_handle_upload('file', $service_id);

        if (is_wp_error($attachment_id)) {
            return new WP_Error(
                'upload_failed',
                $attachment_id->get_error_message(),
                array('status' => 500)
            );
        }

        // Add to gallery
        $current_ids[] = $attachment_id;
        update_post_meta($service_id, '_gallery_image_ids', implode(',', $current_ids));

        return new WP_REST_Response(array(
            'success'       => true,
            'attachment_id' => $attachment_id,
            'urls'          => array(
                'thumbnail' => wp_get_attachment_image_url($attachment_id, 'thumbnail'),
                'medium'    => wp_get_attachment_image_url($attachment_id, 'medium'),
                'large'     => wp_get_attachment_image_url($attachment_id, 'large'),
                'full'      => wp_get_attachment_image_url($attachment_id, 'full'),
            ),
        ), 201);
    }

    /**
     * Reorder gallery images
     */
    public function reorder_media($request) {
        $service_id = $request['id'];
        $order = $request['order'];

        // Verify ownership
        if (!$this->verify_ownership($service_id)) {
            return new WP_Error(
                'forbidden',
                __('You do not have permission to reorder media for this service.', 'batumizone-core'),
                array('status' => 403)
            );
        }

        // Validate order array
        if (!is_array($order)) {
            return new WP_Error(
                'invalid_order',
                __('Order must be an array of attachment IDs.', 'batumizone-core'),
                array('status' => 400)
            );
        }

        // Sanitize and convert to integers
        $order = array_map('intval', $order);

        // Update gallery order
        update_post_meta($service_id, '_gallery_image_ids', implode(',', $order));

        return new WP_REST_Response(array(
            'success' => true,
            'message' => __('Gallery reordered successfully.', 'batumizone-core'),
        ), 200);
    }

    /**
     * Delete media from service
     */
    public function delete_media($request) {
        $service_id = $request['id'];
        $media_id = $request['media_id'];

        // Verify ownership
        if (!$this->verify_ownership($service_id)) {
            return new WP_Error(
                'forbidden',
                __('You do not have permission to delete media from this service.', 'batumizone-core'),
                array('status' => 403)
            );
        }

        // Get current gallery
        $current_gallery = get_post_meta($service_id, '_gallery_image_ids', true);
        $current_ids = !empty($current_gallery) ? explode(',', $current_gallery) : array();

        // Remove media ID from gallery
        $key = array_search($media_id, $current_ids);
        if ($key !== false) {
            unset($current_ids[$key]);
            update_post_meta($service_id, '_gallery_image_ids', implode(',', $current_ids));
        }

        return new WP_REST_Response(array(
            'success' => true,
            'message' => __('Media deleted successfully.', 'batumizone-core'),
        ), 200);
    }

    /**
     * Update service ACF fields
     */
    private function update_service_fields($post_id, $request) {
        // Multilingual fields
        $fields = array(
            'title_ge', 'title_ru', 'title_en',
            'desc_ge', 'desc_ru', 'desc_en',
            'price_model', 'price_value', 'currency',
            'latitude', 'longitude', 'neighborhood',
            'phone', 'whatsapp', 'email'
        );

        foreach ($fields as $field) {
            if (isset($request[$field])) {
                update_field($field, $request[$field], $post_id);
            }
        }
    }

    /**
     * Update service taxonomies (with multilingual tag support)
     */
    private function update_service_taxonomies($post_id, $request) {
        if (isset($request['service_category'])) {
            $term_ids = is_array($request['service_category']) ? $request['service_category'] : array($request['service_category']);
            wp_set_object_terms($post_id, array_map('intval', $term_ids), 'service_category');
        }

        if (isset($request['coverage_area'])) {
            $term_ids = is_array($request['coverage_area']) ? $request['coverage_area'] : array($request['coverage_area']);
            wp_set_object_terms($post_id, array_map('intval', $term_ids), 'coverage_area');
        }

        // Handle service tags (can be IDs or names - supports multilingual tag lookup)
        if (isset($request['service_tags'])) {
            $tags = $request['service_tags'];
            if (!is_array($tags)) {
                $tags = array_map('trim', explode(',', $tags));
            }
            $term_ids = array();
            foreach ($tags as $tag) {
                if (is_numeric($tag)) {
                    $term_ids[] = intval($tag);
                } else {
                    // Find or create tag (with multilingual support)
                    $tag_name = sanitize_text_field($tag);
                    if (!empty($tag_name)) {
                        $term_id = $this->find_or_create_tag($tag_name);
                        if ($term_id) {
                            $term_ids[] = $term_id;
                        }
                    }
                }
            }
            if (!empty($term_ids)) {
                wp_set_object_terms($post_id, array_unique($term_ids), 'service_tag');
            } else {
                wp_set_object_terms($post_id, array(), 'service_tag');
            }
        }
    }

    /**
     * Find existing tag by name (including translations) or create new one
     *
     * @param string $tag_name Tag name to search for
     * @return int|null Term ID if found or created, null on failure
     */
    private function find_or_create_tag($tag_name) {
        $tag_name_lower = strtolower($tag_name);

        // First, try to find by original name
        $existing = get_term_by('name', $tag_name, 'service_tag');
        if ($existing) {
            return $existing->term_id;
        }

        // Search in translated names (case-insensitive)
        $all_tags = get_terms(array(
            'taxonomy'   => 'service_tag',
            'hide_empty' => false,
        ));

        if (!is_wp_error($all_tags)) {
            foreach ($all_tags as $tag) {
                // Check original name (case-insensitive)
                if (strtolower($tag->name) === $tag_name_lower) {
                    return $tag->term_id;
                }

                // Check translated names
                $name_ka = get_term_meta($tag->term_id, 'name_ka', true);
                $name_ru = get_term_meta($tag->term_id, 'name_ru', true);
                $name_en = get_term_meta($tag->term_id, 'name_en', true);

                if (($name_ka && strtolower($name_ka) === $tag_name_lower) ||
                    ($name_ru && strtolower($name_ru) === $tag_name_lower) ||
                    ($name_en && strtolower($name_en) === $tag_name_lower)) {
                    return $tag->term_id;
                }
            }
        }

        // Tag not found, create new one
        $new_term = wp_insert_term($tag_name, 'service_tag');
        if (!is_wp_error($new_term)) {
            return $new_term['term_id'];
        }

        return null;
    }

    /**
     * Get validation status for a service
     */
    private function get_validation_status($post_id) {
        // Use Phase 4.4 validation engine if available
        if (class_exists('Batumi_Validation')) {
            $validation = new Batumi_Validation();
            return $validation->validate_service_listing($post_id);
        }

        // Fallback: basic validation
        return array('valid' => true, 'errors' => array());
    }

    /**
     * Format service for "My Services" response
     */
    private function format_my_service($post) {
        $post_id = $post->ID;

        // Get validation status
        $validation_result = $this->get_validation_status($post_id);

        return array(
            'id'                => $post_id,
            'status'            => $post->post_status,
            'date'              => $post->post_date,
            'modified'          => $post->post_modified,
            'title'             => array(
                'ge' => get_field('title_ge', $post_id) ?: '',
                'ru' => get_field('title_ru', $post_id) ?: '',
                'en' => get_field('title_en', $post_id) ?: '',
            ),
            'description'       => array(
                'ge' => get_field('desc_ge', $post_id) ?: '',
                'ru' => get_field('desc_ru', $post_id) ?: '',
                'en' => get_field('desc_en', $post_id) ?: '',
            ),
            'price'             => array(
                'model'    => get_field('price_model', $post_id),
                'value'    => get_field('price_value', $post_id),
                'currency' => get_field('currency', $post_id),
            ),
            'location'          => array(
                'latitude'     => get_field('latitude', $post_id),
                'longitude'    => get_field('longitude', $post_id),
                'neighborhood' => get_field('neighborhood', $post_id),
            ),
            'contact'           => array(
                'phone'    => get_field('phone', $post_id),
                'whatsapp' => get_field('whatsapp', $post_id),
                'email'    => get_field('email', $post_id),
            ),
            'can_publish'       => $validation_result['valid'],
            'validation_errors' => $validation_result['errors'],
        );
    }

    /**
     * Get service field arguments for validation
     */
    private function get_service_args() {
        return array(
            'title_ge'          => array('sanitize_callback' => 'sanitize_text_field'),
            'title_ru'          => array('sanitize_callback' => 'sanitize_text_field'),
            'title_en'          => array('sanitize_callback' => 'sanitize_text_field'),
            'desc_ge'           => array('sanitize_callback' => 'sanitize_textarea_field'),
            'desc_ru'           => array('sanitize_callback' => 'sanitize_textarea_field'),
            'desc_en'           => array('sanitize_callback' => 'sanitize_textarea_field'),
            'price_model'       => array('sanitize_callback' => 'sanitize_text_field'),
            'price_value'       => array('sanitize_callback' => array($this, 'sanitize_float')),
            'currency'          => array('sanitize_callback' => 'sanitize_text_field'),
            'latitude'          => array('sanitize_callback' => array($this, 'sanitize_float')),
            'longitude'         => array('sanitize_callback' => array($this, 'sanitize_float')),
            'neighborhood'      => array('sanitize_callback' => 'sanitize_text_field'),
            'phone'             => array('sanitize_callback' => 'sanitize_text_field'),
            'whatsapp'          => array('sanitize_callback' => 'sanitize_text_field'),
            'email'             => array('sanitize_callback' => 'sanitize_email'),
            'service_category' => array('type' => 'array'),
            'coverage_area'     => array('type' => 'array'),
            'service_tags'      => array('type' => 'array'),
        );
    }

    /**
     * Verify ownership of a service
     */
    private function verify_ownership($service_id) {
        $post = get_post($service_id);

        if (!$post || $post->post_type !== 'service_listing') {
            return false;
        }

        return $post->post_author == get_current_user_id();
    }

    /**
     * Check if user is authenticated
     */
    public function is_authenticated() {
        return is_user_logged_in();
    }

    /**
     * Sanitize float value for REST API
     */
    public function sanitize_float($value, $request, $param) {
        return floatval($value);
    }
}

// Initialize
new Batumi_Poster_API();
